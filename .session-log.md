# Majel Session Log — 2026-02-10

## What We Did (ADR-018 Phases 3 & 4)

### Phase 3: PostgreSQL Migration (committed `2e08622`)
- Rewrote `db.ts` from @libsql/client → pg Pool
- Migrated all 7 stores to PostgreSQL syntax (settings, sessions, behavior, invite, reference, overlay, dock)
- Rewrote `diagnostic-query.ts` for PG introspection
- Updated config, app-context, index.ts, Dockerfile, routes
- Added `docker-compose.yml` for local PG dev
- Created `test/helpers/pg-test.ts` shared test helper
- Updated 11 test files → 567 tests passing
- Removed @libsql/client dependency

### Phase 4: Cloud Deployment (LIVE)
- Project: `smartergpt-majel` (GCP, billing linked)
- Cloud SQL: `majel-pg` (PostgreSQL 16, db-f1-micro, us-central1)
  - IP: 34.123.112.152
  - DB: `majel`, User: `postgres`
  - Password in Secret Manager: `cloudsql-password`
- Artifact Registry: `us-central1-docker.pkg.dev/smartergpt-majel/majel`
- Secrets: gemini-api-key, majel-admin-token, majel-invite-secret, cloudsql-password, database-url
- Cloud Run: https://majel-166673626107.us-central1.run.app
  - Status: LIVE, health OK, Gemini connected, PG connected
  - 512Mi memory, 0-3 instances, port 8080

## What's Left

### Immediate (next session)
1. **Map custom domain** `aria.smartergpt.dev` → Cloud Run
   - `gcloud run domain-mappings create --service majel --domain aria.smartergpt.dev --region us-central1`
   - Then add DNS records (CNAME) at domain provider
   - Need to know: where is smartergpt.dev DNS managed?

### Phase 5: Reference Data Seeding
- Public catalog is empty (0 officers, 0 ships)
- Need wiki ingest to populate reference data
- Admin sync endpoint

### Phase 6: Polish
- Rate limiting on AI endpoints
- Visitor analytics
- Tenant cleanup cron

## Key Commands
```bash
# Local dev
docker compose up -d        # start local PG
npm run dev                  # start Majel

# Deploy updates
gcloud builds submit --tag us-central1-docker.pkg.dev/smartergpt-majel/majel/majel:latest --quiet
gcloud run deploy majel --image us-central1-docker.pkg.dev/smartergpt-majel/majel/majel:latest --region us-central1 --quiet

# Check production
curl https://majel-166673626107.us-central1.run.app/api/health
gcloud run services logs read majel --region us-central1 --limit 20
```

## Git State
- Branch: main, pushed to origin
- 4 commits ahead of previous session: Phase 1 (`65c1471`), Phase 2 (`1191d38`), ADR revision (`61a0b42`), Phase 3 (`2e08622`)
