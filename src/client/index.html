<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Majel ‚Äî STFC Fleet Intelligence</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="app">
    <!-- Sidebar -->
    <nav id="sidebar">
      <div class="sidebar-header">
        <span class="logo">üññ</span>
        <span class="logo-text">Majel</span>
      </div>
      <button id="new-chat-btn" class="sidebar-action">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 2v12M2 8h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        New chat
      </button>
      <div class="sidebar-section">
        <div class="sidebar-section-label">Tools</div>
        <button id="history-btn" class="sidebar-link">
          <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="6" stroke="currentColor" stroke-width="1.5"/><path d="M8 5v3.5l2.5 1.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          Lex Memory
        </button>
        <button id="recall-btn" class="sidebar-link">
          <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><circle cx="7" cy="7" r="4.5" stroke="currentColor" stroke-width="1.5"/><path d="M10.5 10.5L14 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          Memory recall
        </button>
        <button id="refresh-roster-btn" class="sidebar-link">
          <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M2 8a6 6 0 0110.5-4M14 8a6 6 0 01-10.5 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M12 1v4h-4M4 15v-4h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Refresh roster
        </button>
        <button id="diagnostic-btn" class="sidebar-link">
          <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M2 13h12M4 9h2v4H4zM7 6h2v7H7zM10 3h2v10h-2z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Diagnostic
        </button>
      </div>
      <div class="sidebar-section session-section">
        <div class="sidebar-section-label">Recent Chats</div>
        <div id="session-list" class="session-list"></div>
      </div>
      <div class="sidebar-footer">
        <div id="status-bar">
          <span id="status-indicator" class="status-dot offline"></span>
          <span id="status-text">Connecting...</span>
        </div>
        <span id="roster-status" class="roster-badge"></span>
      </div>
    </nav>

    <!-- Main content -->
    <div id="main">
      <!-- Mobile header -->
      <header id="mobile-header">
        <button id="sidebar-toggle" aria-label="Toggle menu">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M3 5h14M3 10h14M3 15h14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>
        <span class="mobile-title">Majel</span>
        <div class="mobile-status">
          <span id="mobile-status-dot" class="status-dot offline"></span>
        </div>
      </header>

      <!-- Setup Guide (shown when not configured) -->
      <div id="setup-guide" class="hidden">
        <div class="setup-container">
          <h2>‚öôÔ∏è Setup Required</h2>
          <p>Majel needs a couple things configured before she can help you, Admiral.</p>

          <div class="setup-section" id="setup-gemini">
            <h3>1. Gemini API Key <span class="required-badge">Required</span></h3>
            <p>This is the AI engine. Takes about 60 seconds:</p>
            <ol>
              <li>Go to <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener">Google AI Studio ‚Üí API Keys</a></li>
              <li>Click <strong>"Create API key"</strong> (free tier works fine)</li>
              <li>Copy the key</li>
              <li>Open <code>/srv/majel/.env</code> in your editor and paste it:</li>
            </ol>
            <pre>GEMINI_API_KEY=AIzaSy...your-key-here</pre>
            <p class="hint">üí° No Google Cloud project needed ‚Äî AI Studio generates the key directly.</p>
          </div>

          <div class="setup-section" id="setup-sheets">
            <h3>2. Google Sheets <span class="optional-badge">Optional</span></h3>
            <p>Connect your STFC roster spreadsheet for fleet queries. Skip this if you just want to test chat.</p>
            <details>
              <summary>Show setup steps</summary>
              <ol>
                <li>Go to <a href="https://console.cloud.google.com/apis/dashboard" target="_blank" rel="noopener">Google Cloud Console ‚Üí APIs</a></li>
                <li>Select your project, click <strong>"+ ENABLE APIS AND SERVICES"</strong>, search <strong>"Google Sheets API"</strong>, enable it</li>
                <li>Go to <a href="https://console.cloud.google.com/apis/credentials/consent" target="_blank" rel="noopener">OAuth consent screen</a> ‚Üí External ‚Üí fill in app name ("Majel"), your email, add <code>spreadsheets.readonly</code> scope, add yourself as test user</li>
                <li>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank" rel="noopener">Credentials</a> ‚Üí <strong>"+ CREATE CREDENTIALS"</strong> ‚Üí <strong>"OAuth client ID"</strong> ‚Üí type: <strong>Desktop app</strong></li>
                <li>Click <strong>"DOWNLOAD JSON"</strong> ‚Üí save as <code>credentials.json</code> in <code>/srv/majel/</code></li>
                <li>Get your spreadsheet ID from the URL:<br/>
                  <code>https://docs.google.com/spreadsheets/d/<strong>[THIS-ID]</strong>/edit</code></li>
                <li>Add to <code>.env</code>:</li>
              </ol>
              <pre>MAJEL_SPREADSHEET_ID=your-spreadsheet-id
MAJEL_SHEET_RANGE=Sheet1!A1:Z1000</pre>
              <p class="hint">üìÑ Full walkthrough: see <a href="https://github.com" target="_blank">docs/SETUP.md</a></p>
            </details>
          </div>

          <div class="setup-section" id="setup-restart">
            <h3>3. Restart &amp; Go</h3>
            <p>After editing <code>.env</code>, restart the server:</p>
            <pre>npm run dev</pre>
            <p class="hint">This page will auto-detect when setup is complete.</p>
          </div>
        </div>
      </div>

      <!-- View Switcher -->
      <div id="view-switcher" class="view-switcher hidden">
        <button id="ops-level-global" class="ops-level-badge" title="Click to edit Ops Level">
          <span class="ops-label">OPS</span>
          <span class="ops-value" id="ops-level-value">‚Äî</span>
        </button>
        <button class="view-switch-btn active" data-view="chat">
          <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M2 3h12v8H4l-2 2V3z" stroke="currentColor" stroke-width="1.3" stroke-linejoin="round"/></svg>
          Chat
        </button>
        <button class="view-switch-btn" data-view="drydock">
          <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M1 11l3-8h8l3 8H1z" stroke="currentColor" stroke-width="1.3" stroke-linejoin="round"/><path d="M4 11v2h8v-2" stroke="currentColor" stroke-width="1.3" stroke-linejoin="round"/></svg>
          Drydock
        </button>
        <button class="view-switch-btn" data-view="fleet">
          <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><path d="M2 4h12M2 8h12M2 12h8" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>
          Fleet
        </button>
      </div>

      <!-- Chat Area -->
      <main id="chat-area">
        <!-- Welcome screen -->
        <div id="welcome" class="welcome-screen">
          <div class="welcome-icon">üññ</div>
          <h2>Majel</h2>
          <p class="welcome-sub">STFC Fleet Intelligence System</p>
          <div class="welcome-suggestions">
            <button class="suggestion" data-msg="What crew should I use for the Enterprise?">What crew for the Enterprise?</button>
            <button class="suggestion" data-msg="Show me my strongest officers">My strongest officers</button>
            <button class="suggestion" data-msg="What's the current PvP meta?">Current PvP meta?</button>
            <button class="suggestion" data-msg="Help me plan a mining strategy">Mining strategy</button>
          </div>
        </div>

        <!-- Messages -->
        <div id="messages"></div>

        <!-- Scroll anchor -->
        <button id="scroll-bottom" class="scroll-bottom hidden" aria-label="Scroll to bottom">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 3v10M4 9l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </main>

      <!-- Input -->
      <footer id="input-area">
        <form id="chat-form">
          <div class="input-container">
            <textarea
              id="chat-input"
              placeholder="Message Majel..."
              autocomplete="off"
              rows="1"
            ></textarea>
            <button type="submit" id="send-btn" disabled aria-label="Send message">
              <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M3 15l12-6L3 3v5l8 1-8 1z" fill="currentColor"/></svg>
            </button>
          </div>
          <p class="input-hint">Gemini 2.5 Flash-Lite ¬∑ <kbd>Enter</kbd> send ¬∑ <kbd>Shift+Enter</kbd> newline</p>
        </form>
      </footer>

      <!-- Drydock Area (hidden by default, shown via view switcher) -->
      <section id="drydock-area" class="drydock-area hidden"></section>

      <!-- Fleet Manager Area (hidden by default) -->
      <section id="fleet-manager-area" class="fleet-manager-area hidden"></section>
    </div>

    <!-- Recall Dialog -->
    <dialog id="recall-dialog">
      <div class="dialog-header">
        <h3>üîç Memory Recall</h3>
        <button class="dialog-close" id="recall-close" aria-label="Close">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 4l8 8M12 4l-8 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>
      </div>
      <form id="recall-form" method="dialog">
        <input type="text" id="recall-input" placeholder="Search past conversations..." autocomplete="off" />
        <button type="submit">Search</button>
      </form>
      <div id="recall-results"></div>
    </dialog>

    <!-- Diagnostic Dialog -->
    <dialog id="diagnostic-dialog">
      <div class="dialog-header">
        <h3>üìä System Diagnostic</h3>
        <button class="dialog-close" id="diagnostic-close" aria-label="Close">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 4l8 8M12 4l-8 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div id="diagnostic-content" class="diagnostic-content">
        <p class="diagnostic-loading">Querying subsystems...</p>
      </div>
    </dialog>

    <!-- Sidebar overlay (mobile) -->
    <div id="sidebar-overlay" class="hidden"></div>
  </div>

  <script type="module" src="app.js"></script>
</body>
</html>
